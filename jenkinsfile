pipeline {
    agent {
        kubernetes {
            yamlFile 'build-pod.yaml'
            defaultContainer 'ez-docker-helm-build'
        }
    }
    environment {
        GITHUB_CREDENTIALS = credentials('git_hub')
        DOCKER_HUB_USERNAME = credentials('docker_hub')
        DOCKER_HUB_TOKEN = credentials('docker_hub')
        TAG = 'latest'
    }
    stages {
        stage('Checkout') {
            steps {
                // Checkout code from GitHub
                checkout([$class: 'GitSCM', branches: [[name: '*/main']], userRemoteConfigs: [[url: 'https://github.com/maximaxor/devopsfinal.git', credentialsId: 'git_hub']]])
            }
        }
        stage('Setup Docker') {
        steps {
            script {
                def dockerInstalled = sh(script: 'command -v docker', returnStatus: true) == 0
                if (!dockerInstalled) {
                    sh """
                    echo Docker not found, installing...
                    curl -fsSL https://get.docker.com -o get-docker.sh
                    sh get-docker.sh
                    """
                } else {
                    echo "Docker is already installed"
                }
                // Adding current user to Docker group
                sh 'sudo usermod -aG docker $(whoami)'
                }
            }
        }
        stage('Setup Dockerv2') {
            steps {
                script {
                    sh 'ps aux | grep dockerd'
                    sh 'docker version || (sudo dockerd & sleep 10)'
                    sh 'sudo usermod -aG docker $(whoami)'
                    sh 'ls -l /var/run/docker.sock'
                    sh 'docker info'
                }
            }
        }
        stage('Set up Docker Buildx') {
            steps {
                script {
                    sh 'docker version'
                    sh 'docker run --rm --privileged multiarch/qemu-user-static --reset -p yes'
                    def uniqueId = sh(script: 'echo $(date +%s%N | md5sum | head -c 20)', returnStdout: true).trim()
                    def buildxAvailable = sh(script: 'docker buildx version', returnStatus: true) == 0
                    if (buildxAvailable) {
                        sh "docker buildx create --name builder-${uniqueId}"
                        sh "docker buildx use builder-${uniqueId}"
                    } else {
                        echo "Docker buildx is not available. Please ensure you're using Docker 19.03 or later with experimental features enabled."
                    }
                }
            }
        }
        stage('Login to DockerHub') {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: 'docker_hub', passwordVariable: 'DOCKER_HUB_TOKEN', usernameVariable: 'DOCKER_HUB_USERNAME')]) {
                        sh "echo \$DOCKER_HUB_TOKEN | docker login -u \$DOCKER_HUB_USERNAME --password-stdin"
                    }
                }
            }
        }
        stage('Build and Run Containers') {
            steps {
                script {
                    // Sequential build for each service to avoid conflicts
                    def services = [
                        ['name': 'license-registry', 'dockerfile': 'Dockerfile.license-registry'],
                        ['name': 'node', 'dockerfile': './node-app/Dockerfile.node'],
                        ['name': 'image-processor', 'dockerfile': 'Dockerfile.image-processor'],
                        ['name': 'frontend', 'dockerfile': 'Dockerfile.frontend'],
                        ['name': 'orchestrator', 'dockerfile': 'Dockerfile.orchestrator'],
                        ['name': 'api-gateway', 'dockerfile': 'Dockerfile.api-gateway'],
                        ['name': 'mongodb', 'dockerfile': './mongodb/Dockerfile.mongodb']
                    ]
                    services.each { service ->
                        def buildName = "builder-${service.name}"
                        sh "docker buildx create --use --name ${buildName}"
                        sh "docker build -t maximusmaxi/${service.name}:${TAG} -f ${service.dockerfile} ."
                        sh "docker buildx rm ${buildName}"
                    }
                }
            }
        }
        stage('Test') {
            steps {
                container('python-test') {
                    script {
                        sh '''
                            pytest
                        '''
                    }
                }
            }
        }
        stage('Push Images to Docker Hub') {
            steps {
                script {
                    def services = ['license-registry', 'node-app', 'image-processor', 'frontend', 'orchestrator', 'api-gateway', 'mongodb']
                    withCredentials([usernamePassword(credentialsId: 'docker_hub', passwordVariable: 'DOCKER_HUB_TOKEN', usernameVariable: 'DOCKER_HUB_USERNAME')]) {
                        sh "docker login -u \$DOCKER_HUB_USERNAME -p \$DOCKER_HUB_TOKEN"
                        services.each { service ->
                            sh "docker push maximusmaxi/${service}:${TAG}"
                        }
                    }
                }
            }
        }
        stage('Cleanup') {
            steps {
                script {
                    sh 'kubectl delete pod jenkins-agent-pod --ignore-not-found'
                    sh 'kubectl delete pod tests --ignore-not-found'
                }
            }
        }
    }
}
