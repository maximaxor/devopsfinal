pipeline {
    agent {
        kubernetes {
            yamlFile 'build-pod.yaml'
            defaultContainer 'ez-docker-helm-build'
        }
    }
    environment {
        GITHUB_CREDENTIALS = credentials('git_hub')
        DOCKER_HUB_USERNAME = credentials('docker_hub')
        DOCKER_HUB_TOKEN = credentials('docker_hub')
        TAG = 'latest'
    }
    options {
        // Keep 5 builds for debugging purposes
        buildDiscarder(logRotator(numToKeepStr: '5'))
        // Set timeouts to avoid hanging jobs
        timeout(time: 60, unit: 'MINUTES')
    }
    stages {
        stage('Checkout') {
            steps {
                script {
                    echo "Starting checkout stage"
                    // Checkout code from GitHub
                    checkout([$class: 'GitSCM', branches: [[name: '*/main']], userRemoteConfigs: [[url: 'https://github.com/maximaxor/devopsfinal.git', credentialsId: 'git_hub']]])
                    echo "Checkout completed"
                }
            }
        }
        stage('Install Docker if not present') {
            steps {
                script {
                    echo "Checking Docker installation"
                    // Check if Docker is installed and install it if not
                    sh '''
                        if ! command -v docker &> /dev/null
                        then
                            echo "Docker not found, installing..."
                            curl -fsSL https://get.docker.com -o get-docker.sh
                            sh get-docker.sh
                            sudo usermod -aG docker $(whoami)
                        else
                            echo "Docker is already installed"
                        fi
                    '''
                    echo "Docker installation check completed"
                }
            }
        }
        stage('Install Kubectl') {
            steps {
                script {
                    echo "Installing kubectl"
                    sh '''
                        curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
                        chmod +x kubectl
                        mv kubectl /usr/local/bin/
                    '''
                    echo "Kubectl installation completed"
                }
            }
        }
        stage('Set up Docker Buildx') {
            steps {
                script {
                    echo "Setting up Docker Buildx"
                    retry(3) {
                        sh 'docker run --rm --privileged multiarch/qemu-user-static --reset -p yes'
                        sh 'docker buildx create --use --name builder-$(uuidgen)'
                    }
                    echo "Docker Buildx setup completed"
                }
            }
        }
        stage('Login to DockerHub') {
            steps {
                script {
                    echo "Logging in to DockerHub"
                    withCredentials([usernamePassword(credentialsId: 'docker_hub', passwordVariable: 'DOCKER_HUB_TOKEN', usernameVariable: 'DOCKER_HUB_USERNAME')]) {
                        sh "echo \$DOCKER_HUB_TOKEN | docker login -u \$DOCKER_HUB_USERNAME --password-stdin"
                    }
                    echo "DockerHub login completed"
                }
            }
        }
        stage('Build and Run Containers') {
            steps {
                script {
                    echo "Building and running containers"
                    def services = [
                        ['name': 'license-registry', 'dockerfile': 'Dockerfile.license-registry'],
                        ['name': 'node', 'dockerfile': './node-app/Dockerfile.node'],
                        ['name': 'image-processor', 'dockerfile': 'Dockerfile.image-processor'],
                        ['name': 'frontend', 'dockerfile': 'Dockerfile.frontend'],
                        ['name': 'orchestrator', 'dockerfile': 'Dockerfile.orchestrator'],
                        ['name': 'api-gateway', 'dockerfile': 'Dockerfile.api-gateway'],
                        ['name': 'mongodb', 'dockerfile': './mongodb/Dockerfile.mongodb']
                    ]
                    services.each { service ->
                        def buildName = "builder-${service.name}"
                        echo "Building ${service.name}"
                        retry(3) {
                            sh "docker buildx create --use --name ${buildName}"
                            sh "docker build -t maximusmaxi/${service.name}:${TAG} -f ${service.dockerfile} ."
                            sh "docker buildx rm ${buildName}"
                        }
                        echo "${service.name} build completed"
                    }
                }
            }
        }
        stage('Test') {
            steps {
                container('python-test') {
                    script {
                        echo "Running tests"
                        sh 'pytest'
                        echo "Tests completed"
                    }
                }
            }
        }
        stage('Push Images to Docker Hub') {
            steps {
                script {
                    echo "Pushing images to DockerHub"
                    def services = ['license-registry', 'node', 'image-processor', 'frontend', 'orchestrator', 'api-gateway', 'mongodb']
                    withCredentials([usernamePassword(credentialsId: 'docker_hub', passwordVariable: 'DOCKER_HUB_TOKEN', usernameVariable: 'DOCKER_HUB_USERNAME')]) {
                        sh "echo \$DOCKER_HUB_TOKEN | docker login -u \$DOCKER_HUB_USERNAME --password-stdin"
                        services.each { service ->
                            retry(3) {
                                sh "DOCKER_CLI_EXPERIMENTAL=enabled docker push maximusmaxi/${service}:${TAG}"
                            }
                        }
                    }
                    echo "Images pushed to DockerHub"
                }
            }
        }
        stage('Cleanup') {
            steps {
                script {
                    echo "Cleaning up"
                    sh 'kubectl delete pod jenkins-agent-pod --ignore-not-found'
                    sh 'kubectl delete pod tests --ignore-not-found'
                    echo "Cleanup completed"
                }
            }
        }
    }
    post {
        always {
            echo "Pipeline finished"
            cleanWs() // Clean up workspace after each run
        }
        failure {
            echo "Pipeline failed"
            // Send notification or additional logging
        }
    }
}
